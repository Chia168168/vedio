<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>iPhone 全螢幕影片播放器</title>
<style>
:root {
  --bg: #f8f7fa;
  --panel: #ffffff;
  --accent: #6c43ff;
  --muted: #888;
  --thumb-h: 64px;
}
body {
  margin: 0; background: var(--bg); font-family: -apple-system, "Noto Sans TC", sans-serif;
  display: flex; flex-direction: column; align-items: center; padding: 10px;
}
.container {
  width: 100%; max-width: 900px; background: var(--panel); border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06); padding: 10px;
}
video {
  width: 100%; max-height: 360px; background: #000; border-radius: 8px;
}
.controls {
  display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px;
}
button {
  padding: 8px 12px; border-radius: 10px; font-size: 15px; border: 1px solid #ccc;
  background: #fff;
}
button.accent { background: var(--accent); color: #fff; border: none; }
#timeDisplay { text-align: center; margin-top: 6px; color: var(--muted); }
.thumbs {
  display: flex; overflow-x: auto; white-space: nowrap; gap: 6px; padding: 6px;
  background: #f9f8fd; border-radius: 8px; margin-top: 8px;
}
.thumb { position: relative; flex: 0 0 auto; border-radius: 6px; overflow: hidden; }
.thumb canvas { height: var(--thumb-h); display: block; }
.thumb.active::after {
  content: ""; position: absolute; inset: 3px; border: 3px solid var(--accent); border-radius: 4px;
}
.range { width: 100%; }
.file-label {
  display: inline-block; padding: 8px 12px; background: #fff; border: 1px solid #ccc;
  border-radius: 10px; margin-bottom: 8px;
}
</style>
</head>
<body>

<div class="container">
  <label class="file-label">選擇影片 <input type="file" id="fileInput" accept="video/*" style="display:none"></label>
  <video id="video" playsinline webkit-playsinline></video>

  <div class="controls">
    <button id="backBtn">◀◀ 5秒</button>
    <button id="playBtn" class="accent">播放</button>
    <button id="forwardBtn">5秒 ▶▶</button>
    <button id="prevFrameBtn">上格</button>
    <button id="nextFrameBtn">下格</button>
    <button id="saveFrameBtn">儲存畫面</button>
  </div>

  <div id="timeDisplay">00:00.00 / 00:00.00</div>

  <div class="thumbs" id="thumbs"></div>
</div>

<canvas id="hiddenCanvas" style="display:none"></canvas>
<a id="downloadAnchor" style="display:none"></a>

<script>
const video = document.getElementById('video');
const fileInput = document.getElementById('fileInput');
const playBtn = document.getElementById('playBtn');
const backBtn = document.getElementById('backBtn');
const forwardBtn = document.getElementById('forwardBtn');
const saveFrameBtn = document.getElementById('saveFrameBtn');
const prevFrameBtn = document.getElementById('prevFrameBtn');
const nextFrameBtn = document.getElementById('nextFrameBtn');
const timeDisplay = document.getElementById('timeDisplay');
const thumbs = document.getElementById('thumbs');
const hiddenCanvas = document.getElementById('hiddenCanvas');
const downloadAnchor = document.getElementById('downloadAnchor');

let duration = 0;
let fps = 30;
let thumbCount = 30;
let dragging = false;

// 載入影片
fileInput.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  video.src = url;
  video.load();
});

video.addEventListener('loadedmetadata', async () => {
  duration = video.duration;
  fps = await getFPS(video) || 30;
  console.log('偵測到 FPS:', fps);
  updateTime();
  generateThumbs();
});

// 播放/暫停
playBtn.addEventListener('click', () => {
  if (video.paused) {
    video.play();
    playBtn.textContent = '暫停';
  } else {
    video.pause();
    playBtn.textContent = '播放';
  }
});
video.addEventListener('ended', () => playBtn.textContent = '播放');

// 前進/後退
backBtn.onclick = () => video.currentTime = Math.max(0, video.currentTime - 5);
forwardBtn.onclick = () => video.currentTime = Math.min(duration, video.currentTime + 5);

// 上格/下格
prevFrameBtn.onclick = () => video.currentTime = Math.max(0, video.currentTime - 1/fps);
nextFrameBtn.onclick = () => video.currentTime = Math.min(duration, video.currentTime + 1/fps);

// 儲存畫面
saveFrameBtn.onclick = () => {
  const w = video.videoWidth, h = video.videoHeight;
  hiddenCanvas.width = w; hiddenCanvas.height = h;
  hiddenCanvas.getContext('2d').drawImage(video, 0, 0, w, h);
  hiddenCanvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    downloadAnchor.href = url;
    downloadAnchor.download = `frame_${Math.floor(video.currentTime*1000)}.png`;
    downloadAnchor.click();
  });
};

// 更新時間顯示
video.addEventListener('timeupdate', updateTime);
function updateTime() {
  const t = video.currentTime, total = video.duration || 0;
  const format = x => {
    const m = Math.floor(x/60).toString().padStart(2,'0');
    const s = Math.floor(x%60).toString().padStart(2,'0');
    const cs = Math.floor((x%1)*100).toString().padStart(2,'0');
    return `${m}:${s}.${cs}`;
  };
  timeDisplay.textContent = `${format(t)} / ${format(total)} (${Math.floor(t*fps)} frame)`;
  highlightThumb(t);
}

// 自動偵測FPS
async function getFPS(video) {
  try {
    const track = video.captureStream().getVideoTracks()[0];
    if (track.getSettings && track.getSettings().frameRate)
      return track.getSettings().frameRate;
  } catch(e){ console.log('無法自動抓FPS，使用預設30'); }
  return 30;
}

// 生成縮圖
async function generateThumbs() {
  thumbs.innerHTML = '';
  const step = duration / thumbCount;
  const w = 160, h = 90;
  for (let i = 0; i < thumbCount; i++) {
    const t = i * step;
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    await seekAndDraw(t, ctx, w, h);
    const div = document.createElement('div');
    div.className = 'thumb';
    div.dataset.time = t;
    div.appendChild(canvas);
    thumbs.appendChild(div);
  }
  // 拖曳事件
  thumbs.addEventListener('touchstart', startDrag, {passive:true});
  thumbs.addEventListener('touchmove', dragMove, {passive:true});
  thumbs.addEventListener('touchend', endDrag);
  thumbs.querySelectorAll('.thumb').forEach(el=>{
    el.addEventListener('click',()=>{ video.currentTime=parseFloat(el.dataset.time); });
  });
}

// 拖曳縮圖即時跳轉
function startDrag(e){ dragging=true; dragMove(e); }
function dragMove(e){
  if(!dragging) return;
  const touch = e.touches[0];
  const rect = thumbs.getBoundingClientRect();
  const x = touch.clientX - rect.left + thumbs.scrollLeft;
  const ratio = x / rect.width;
  const time = Math.max(0, Math.min(duration, duration * ratio));
  video.currentTime = time;
}
function endDrag(){ dragging=false; }

async function seekAndDraw(t, ctx, w, h){
  return new Promise(resolve=>{
    const handler = () => {
      video.removeEventListener('seeked', handler);
      try { ctx.drawImage(video, 0, 0, w, h); } catch(e){}
      resolve();
    };
    video.addEventListener('seeked', handler);
    video.currentTime = Math.min(duration, t);
  });
}

// 突顯當前縮圖
function highlightThumb(t){
  const list = [...thumbs.children];
  if(!list.length) return;
  const nearest = list.reduce((a,b)=>
    Math.abs(parseFloat(b.dataset.time)-t) < Math.abs(parseFloat(a.dataset.time)-t) ? b : a
  );
  list.forEach(x=>x.classList.remove('active'));
  nearest.classList.add('active');
  nearest.scrollIntoView({behavior:'smooth',inline:'center'});
}
</script>

</body>
</html>
